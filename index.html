<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMR Prediction System</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; background-color: #f4f4f9; }
        .container { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; text-align: center; }
        .upload-box { border: 2px dashed #3498db; padding: 2rem; text-align: center; margin-bottom: 2rem; border-radius: 8px; }
        button { background: #3498db; color: white; border: none; padding: 10px 20px; font-size: 1rem; cursor: pointer; border-radius: 5px; margin-top: 10px; }
        button:hover { background: #2980b9; }
        button:disabled { background: #ccc; }
        #results { margin-top: 2rem; display: none; }
        .stat-box { background: #ecf0f1; padding: 10px; margin: 5px 0; border-radius: 4px; }
        .resistant { color: #e74c3c; font-weight: bold; }
        .susceptible { color: #27ae60; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
        th { background-color: #f8f9fa; }
    </style>
</head>
<body>

<div class="container">
    <h1>ðŸ§¬ AMR Gen-Resist Predictor</h1>
    
    <div class="upload-box">
        <h3>Upload Genome File (.fasta)</h3>
        <input type="file" id="fileInput" accept=".fasta,.fna,.fa">
        <br>
        <button onclick="uploadFile()" id="predictBtn">Analyze Genome</button>
        <p id="statusText" style="color: gray; margin-top: 10px;"></p>
    </div>

    <div id="results">
        <h2>ðŸ“Š Analysis Results</h2>
        
        <div class="stat-box">
            <strong>Detected Genes:</strong> <span id="genesList"></span>
        </div>
        <div class="stat-box">
            <strong>Genome Stats:</strong> GC Content: <span id="gcContent"></span> | Length Norm: <span id="lenNorm"></span>
        </div>

        <h3>Antibiotic Resistance Profile</h3>
        <table id="resTable">
            <thead>
                <tr>
                    <th>Antibiotic</th>
                    <th>Prediction</th>
                    <th>Probability</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>
</div>

<script>
    async function uploadFile() {
        const fileInput = document.getElementById('fileInput');
        const statusText = document.getElementById('statusText');
        const btn = document.getElementById('predictBtn');
        
        if (fileInput.files.length === 0) {
            alert("Please select a file first!");
            return;
        }

        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append("file", file);

        // UI Loading State
        btn.disabled = true;
        btn.innerText = "Processing...";
        statusText.innerText = "Uploading to AI Model...";
        document.getElementById('results').style.display = 'none';

        try {
            // BACKEND URL - Make sure port matches your uvicorn port
            const response = await fetch("http://127.0.0.1:8000/predict", {
                method: "POST",
                body: formData
            });

            if (!response.ok) {
                throw new Error(`Server Error: ${response.statusText}`);
            }

            const data = await response.json();
            displayResults(data);
            statusText.innerText = "Analysis Complete!";

        } catch (error) {
            console.error(error);
            statusText.innerText = "Error: " + error.message;
            alert("Failed to connect to backend. Is it running?");
        } finally {
            btn.disabled = false;
            btn.innerText = "Analyze Genome";
        }
    }

    function displayResults(data) {
        // Show container
        document.getElementById('results').style.display = 'block';

        // Fill Stats
        document.getElementById('genesList').innerText = data.detected_genes.length > 0 ? data.detected_genes.join(", ") : "None detected";
        document.getElementById('gcContent').innerText = (data.genome_stats.gc_content * 100).toFixed(2) + "%";
        document.getElementById('lenNorm').innerText = data.genome_stats.length_normalized.toFixed(4);

        // Fill Table
        const tbody = document.querySelector("#resTable tbody");
        tbody.innerHTML = ""; // Clear previous

        // Loop through predictions object
        for (const [antibiotic, prediction] of Object.entries(data.predictions)) {
            const prob = data.probabilities[antibiotic];
            const row = `
                <tr>
                    <td>${antibiotic}</td>
                    <td class="${prediction.toLowerCase()}">${prediction}</td>
                    <td>
                        <div style="background:#eee; width:100px; height:10px; display:inline-block; margin-right:5px; border-radius:5px;">
                            <div style="background:${prediction === 'Resistant' ? '#e74c3c' : '#27ae60'}; width:${prob*100}%; height:100%; border-radius:5px;"></div>
                        </div>
                        ${(prob * 100).toFixed(1)}%
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        }
    }
</script>

</body>
</html>